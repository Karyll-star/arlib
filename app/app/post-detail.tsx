import React, { useState } from 'react';
import { View, Text, ScrollView, Image, TouchableOpacity, TextInput, KeyboardAvoidingView, Platform, FlatList } from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import { useRouter, useLocalSearchParams } from 'expo-router';
import { Ionicons } from '@expo/vector-icons';

// Mock Data Sets
const COMMENT_SETS = [
  [
    { id: '1', user: 'SciFiLover', avatar: 'bg-indigo-100', content: 'å®Œå…¨åŒæ„ï¼é»‘æš—æ£®æ—æ³•åˆ™è§£é‡Šäº†è´¹ç±³æ‚–è®ºï¼Œå¤ªéœ‡æ’¼äº†ã€‚', time: '1å°æ—¶å‰', likes: 45 },
    { id: '2', user: 'PhysicsGeek', avatar: 'bg-orange-100', content: 'å…¶å®æˆ‘è§‰å¾—æœ‰äº›è®¾å®šè¿‡äºæ‚²è§‚äº†ï¼Œæ–‡æ˜ä¹‹é—´é™¤äº†çŒœç–‘é“¾ï¼Œåº”è¯¥ä¹Ÿæœ‰äº¤æµçš„å¯èƒ½æ€§å§ï¼Ÿ', time: '30åˆ†é’Ÿå‰', likes: 12 },
    { id: '3', user: 'LibraryCat', avatar: 'bg-gray-100', content: 'æ¥¼ä¸»åˆ†æå¾—å¾ˆé€å½»ï¼Œåç­‰ç¬¬ä¸‰éƒ¨è¯»åæ„Ÿï¼', time: '5åˆ†é’Ÿå‰', likes: 8 },
  ],
  [
    { id: '1', user: 'BookWorm_99', avatar: 'bg-green-100', content: 'è¿™ä¹Ÿå¤ªå®ç”¨äº†ï¼æˆ‘ä¹Ÿè¦å»è¯•è¯•è¿™ä¸ªé˜…è¯»æ–¹æ³•ã€‚', time: '2å°æ—¶å‰', likes: 23 },
    { id: '2', user: 'StudyHard', avatar: 'bg-blue-100', content: 'æ„Ÿè°¢åˆ†äº«ï¼Œæœ€è¿‘æ­£æ„çœ‹ä¹¦æ•ˆç‡ä½å‘¢ã€‚', time: '1å°æ—¶å‰', likes: 5 },
  ],
  [
    { id: '1', user: 'TechSavvy', avatar: 'bg-purple-100', content: 'ARå¯¼èˆªç¡®å®æ–¹ä¾¿ï¼Œä¸è¿‡æœ‰æ—¶å€™åœ¨è§’è½é‡Œä¿¡å·ä¸å¤ªå¥½ã€‚', time: '1å¤©å‰', likes: 18 },
    { id: '2', user: 'NewUser007', avatar: 'bg-red-100', content: 'å¸Œæœ›èƒ½å¢åŠ æ›´å¤šäº’åŠ¨åŠŸèƒ½ï¼Œæ¯”å¦‚å¯»å®æ¸¸æˆä¹‹ç±»çš„ã€‚', time: '5å°æ—¶å‰', likes: 9 },
    { id: '3', user: 'Librarian_Jane', avatar: 'bg-yellow-100', content: 'æˆ‘ä»¬ä¼šæŒç»­ä¼˜åŒ–çš„ï¼Œæ„Ÿè°¢åé¦ˆï¼', time: '1å°æ—¶å‰', likes: 42 },
  ]
];

// Helper to pick comments based on a string hash
const getCommentsForPost = (title) => {
  if (!title) return COMMENT_SETS[0];
  let hash = 0;
  for (let i = 0; i < title.length; i++) {
    hash = title.charCodeAt(i) + ((hash << 5) - hash);
  }
  const index = Math.abs(hash) % COMMENT_SETS.length;
  return COMMENT_SETS[index];
};

const CommentItem = ({ item }) => (
  <View className="flex-row mb-6">
    <View className={`w-10 h-10 rounded-full ${item.avatar} items-center justify-center mr-3`}>
       <Text className="text-base">ğŸ‘¤</Text>
    </View>
    <View className="flex-1">
       <View className="flex-row justify-between items-center mb-1">
          <Text className="text-text-main font-bold text-sm">{item.user}</Text>
          <Text className="text-gray-400 text-xs">{item.time}</Text>
       </View>
       <Text className="text-text-main leading-5 text-sm mb-2">{item.content}</Text>
       
       <View className="flex-row space-x-4">
          <TouchableOpacity className="flex-row items-center">
             <Ionicons name="heart-outline" size={14} color="#9ca3af" />
             <Text className="text-gray-500 text-xs ml-1">{item.likes}</Text>
          </TouchableOpacity>
          <TouchableOpacity>
             <Text className="text-gray-500 text-xs font-medium">å›å¤</Text>
          </TouchableOpacity>
       </View>
    </View>
  </View>
);

export default function PostDetailScreen() {
  const router = useRouter();
  const params = useLocalSearchParams();
  const [isLiked, setIsLiked] = useState(false);
  const [likeCount, setLikeCount] = useState(Number(params.likes) || 342);
  
  const comments = getCommentsForPost(params.title);

  const toggleLike = () => {
    setIsLiked(!isLiked);
    setLikeCount(prev => isLiked ? prev - 1 : prev + 1);
  };

  return (
    <SafeAreaView className="flex-1 bg-background">
      {/* Header */}
      <View className="flex-row justify-between items-center px-4 py-3 border-b border-gray-100 bg-background">
        <TouchableOpacity onPress={() => router.back()}>
           <Ionicons name="arrow-back" size={24} color="#2C3333" />
        </TouchableOpacity>
        <Text className="font-bold text-lg text-text-main">å¸–å­è¯¦æƒ…</Text>
        <TouchableOpacity>
           <Ionicons name="ellipsis-horizontal" size={24} color="#2C3333" />
        </TouchableOpacity>
      </View>

      <ScrollView className="flex-1" showsVerticalScrollIndicator={false}>
         
         {/* Author Info */}
         <View className="flex-row items-center px-4 py-4">
            <View className={`w-12 h-12 rounded-full ${params.avatarColor || 'bg-primary/10'} items-center justify-center mr-3`}>
               <Text className="text-xl">ğŸ‘¤</Text>
            </View>
            <View className="flex-1">
               <Text className="font-bold text-text-main text-base">{params.user || 'Unknown User'}</Text>
               <Text className="text-gray-400 text-xs">{params.time || 'åˆšåˆš'}</Text>
            </View>
            <TouchableOpacity className="bg-primary px-4 py-1.5 rounded-full">
               <Text className="text-white text-xs font-bold">å…³æ³¨</Text>
            </TouchableOpacity>
         </View>

         {/* Content Body */}
         <View className="px-4 mb-6">
            <Text className="text-xl font-bold text-text-main mb-3 leading-tight">
               {params.title || 'å¸–å­æ ‡é¢˜'}
            </Text>
            <Text className="text-text-main text-base leading-7">
               {params.content || 'å¸–å­å†…å®¹...'}
               {
                 '\n\n'
               }
               ï¼ˆæ­¤å¤„ä¸ºæ¨¡æ‹Ÿçš„é•¿æ–‡æœ¬å†…å®¹ï¼Œç”¨äºå±•ç¤ºè¯¦æƒ…é¡µçš„æ’ç‰ˆæ•ˆæœã€‚åœ¨çœŸå®åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºå®Œæ•´çš„å¸–å­æ­£æ–‡ã€‚ï¼‰
            </Text>
            
            {/* Tags */}
            <View className="flex-row mt-4">
               <View className="bg-white px-3 py-1 rounded-lg border border-gray-100">
                  <Text className="text-gray-500 text-xs">#{params.tag || 'è¯é¢˜'}</Text>
               </View>
            </View>
         </View>

         <View className="h-2 bg-gray-100 mb-6" />

         {/* Comments Section */}
         <View className="px-4 pb-24">
            <Text className="font-bold text-lg text-text-main mb-6">å…¨éƒ¨è¯„è®º ({comments.length})</Text>
            {comments.map(item => <CommentItem key={item.id} item={item} />)}
         </View>

      </ScrollView>

      {/* Floating Action Bar */}
      <KeyboardAvoidingView 
         behavior={Platform.OS === "ios" ? "padding" : "height"} 
         keyboardVerticalOffset={Platform.OS === "ios" ? 0 : 0}
         className="absolute bottom-0 left-0 right-0 bg-white border-t border-gray-100 px-4 py-3 flex-row items-center justify-between shadow-lg"
      >
         <View className="flex-1 bg-background rounded-full px-4 py-2 mr-4 border border-gray-200">
            <TextInput 
               placeholder="å†™ä¸‹ä½ çš„æƒ³æ³•..." 
               className="text-base text-text-main"
               placeholderTextColor="#9ca3af"
            />
         </View>
         
         <View className="flex-row space-x-5 items-center">
            <TouchableOpacity onPress={toggleLike} className="items-center">
               <Ionicons name={isLiked ? "heart" : "heart-outline"} size={26} color={isLiked ? "#ef4444" : "#4b5563"} />
               <Text className="text-[10px] text-gray-500 font-medium">{likeCount}</Text>
            </TouchableOpacity>
            
            <TouchableOpacity className="items-center">
               <Ionicons name="chatbubble-outline" size={24} color="#4b5563" />
               <Text className="text-[10px] text-gray-500 font-medium">{params.comments || 56}</Text>
            </TouchableOpacity>
            
            <TouchableOpacity className="items-center">
               <Ionicons name="share-social-outline" size={24} color="#4b5563" />
            </TouchableOpacity>
         </View>
      </KeyboardAvoidingView>
    </SafeAreaView>
  );
}